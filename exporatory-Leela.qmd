---
title: "exporatory-Leela"
format: html
---

```{r}
library(tidyverse)
library(janitor)
library(dplyr)
library(tmap)
library(sf)
library(here)
library(stars)
library(spData)
library(terra)
library(riverconn)
library(igraph)
library(tidygraph)
library(sfnetworks)
library(lwgeom)
```

Load dataframes 
```{r}
# Dams
current_dams <- read_sf("../../../../capstone/netzerohydro/data/GRanD_Version_1_3") %>% 
  clean_names()

future_dams <- read_csv('../../../../capstone/netzerohydro/data/FHReD_2015_future_dams/FHReD_2015_future_dams_Zarfl_et_al_beta_version.csv') %>% 
  clean_names()

# Population
global_pop_sf <- read_stars('../../../../capstone/netzerohydro/data/global_pop_2020_CN_1km_R2025A_UA_v1.tif') %>% 
  clean_names()

global_pop_rast <- rast('../../../../capstone/netzerohydro/data/global_pop_2020_CN_1km_R2025A_UA_v1.tif') %>% 
  clean_names()

# Water Basin
basin_level3 <- read_sf('../../../../capstone/netzerohydro/data/hybas_as_lev03_v1c/hybas_as_lev03_v1c.shp') %>% 
  clean_names()

# Rivers
asia_rivers <- read_sf('../../../../capstone/netzerohydro/data/HydroRIVERS_v10_as.gdb') %>% 
  clean_names()

# nepal rivers order 3up
nepal_rivers_3up <- readRDS("../../../../../capstone/netzerohydro/data/cleaned_v1/nepal_rivers_3up.rds")

```

Making `future_dams` spatial  
```{r}
future_dams <- st_as_sf(future_dams,
         coords = c('lon_cleaned', 'lat_cleaned'), 
         crs = st_crs(current_dams))
```

Nepal Basin 
```{r}
nepal_basin <- basin_level3 %>% 
  filter(hybas_id == 4030025450)
```

Filtering Rivers to order 2 or 3 
```{r}
asia_rivers2 <- asia_rivers %>%
  filter(ord_clas == 2)

asia_rivers3 <- asia_rivers %>% 
  filter(ord_clas >= 3)

# Look at difference between river order 2 vs 3 
tm_shape(asia_rivers2) +
  tm_lines()

tm_shape(asia_rivers3) + 
  tm_lines()
```


Making geometeries valid 
```{r}
current_dams <- st_make_valid(current_dams)
future_dams <- st_make_valid(future_dams)
nepal_basin <- st_make_valid(nepal_basin)
asia_rivers2 <- st_make_valid(asia_rivers2)
asia_rivers3 <- st_make_valid(asia_rivers3)
```

Crop dams and rivers to Nepal basin 
```{r}
nepal_current_dams <- st_intersection(nepal_basin, current_dams)
nepal_future_dams <- st_intersection(nepal_basin, future_dams)
# nepal_rivers3 <- st_intersects(nepal_basin, asia_rivers3)
# nepal_rivers2 <- st_intersects(nepal_basin, asia_rivers2)

nepal_rivers <- asia_rivers3 %>% 
  st_filter(y = nepal_basin, .predicate = st_intersects)
```

Map! 
```{r}
tm_shape(nepal_basin) + 
  tm_polygons(fill_alpha = 0.4, lwd = 2.5) + 
  tm_basemap('Esri.WorldTopoMap') + 
  tm_shape(nepal_current_dams) + 
  tm_dots(fill = "red") + 
  tm_shape(nepal_future_dams) + 
  tm_dots(fill = "blue") + 
  #tm_shape(nepal_rivers2) + 
  #tm_lines() + 
  tm_add_legend(type = "polygons", 
                labels = c("Current Dams", "Future Dams"), 
                fill = c("red", "blue"), 
                title = "Dam Status") + 
  tm_title(text = "Dams in Nepal") + 
  tm_compass() + 
  tm_scalebar()

```

Plot rivers for crop of Nepal
```{r}
tm_shape(nepal_rivers) +
  tm_lines() +
tm_shape(current_dams) +
  tm_dots() +
  tm_graticules() 

# Dams are not on the river networks, so we can snap them together?
crs(nepal_rivers)
crs(current_dams)
```

Problem: Tried to make rivers into points, but too much overlap to identify confluences I think. don't know how to define points on the rivers, then don't know how to map a line along the river between 2 points.

trying with tidygraph
```{r}
nepal_edges <- nepal_rivers %>%
  mutate(edgeID = c(1:n()))


nepal_nodes <- nepal_edges %>%
  st_coordinates() %>%
  as_tibble() %>%
  rename(edgeID = L1) %>%
  group_by(edgeID) %>%
  slice(c(1, n())) %>%
  ungroup() %>%
  mutate(start_end = rep(c('start', 'end'), times = n()/2))

nepal_nodes <- st_as_sf(nepal_nodes, coords = c("Y", "X"), crs = 4326)

nepal_nodes <- nepal_nodes %>%
  mutate(xy = paste(.$X, .$Y)) %>%
  mutate(nodeID = group_indices(., factor(xy, levels = unique(xy)))) %>%
  select(-xy)

source_nodes <- nepal_nodes %>%
  filter(start_end == 'start') %>%
  pull(nodeID)
target_nodes <- nepal_nodes %>%
  filter(start_end == 'end') %>%
  pull(nodeID)
nepal_edges = nepal_edges %>%
  mutate(from = source_nodes, to = target_nodes)

nepal_nodes1 <- nepal_nodes %>%
  distinct(nodeID, .keep_all = TRUE) %>%
  select(-c(edgeID, start_end)) %>%
  st_as_sf(coords = c('X', 'Y')) %>%
  st_set_crs(st_crs(nepal_edges))

nepal_graph = igraph::tbl_graph(nepal_nodes = nepal_nodes, nepal_edges = as_tibble(nepal_edges), directed = FALSE)
```

```{r}
tm_shape(nepal_nodes1) +
  tm_dots()
```

bbox for one river
```{r}
box_poly <- st_as_sfc(
  st_bbox(c(xmin = 83.56, xmax = 83.6987, ymin = 28.328360, ymax = 28.704314), 
          crs = st_crs(nepal_basin)))

trial_current_dams <- st_intersection(box_poly, nepal_current_dams)
trial_future_dams <- st_intersection(box_poly, nepal_future_dams)
trial_river <- nepal_rivers %>%
  st_filter(y = box_poly, .predicate = st_intersects)

trial_future_dams_sf <- st_sf(trial_future_dams)
dam1 <- trial_future_dams_sf[1,]
dam2 <- trial_future_dams_sf[2,]
```


Trying sf network 
```{r}
nepal_river_net <- as_sfnetwork(trial_river)
```

```{r}
# quick plot only nodes
plot(nepal_river_net, draw_lines = FALSE) # sooo many nodes in full nepal
# quick plot notes and connecting lines
plot(nepal_river_net)
```

```{r}
# transform data to sfnetwork type and 
net <- as_sfnetwork(trial_river) %>% 
  activate("edges") %>%
  mutate(weight = edge_length())

net_df <- as_tibble(net)

# define path
paths = st_network_paths(net, from = 3, to = 15, weight = "weight")

# lists nodes
paths %>%
  slice(1) %>%
  pull(node_paths) %>%
  unlist()
# lists edges
paths %>%
  slice(1) %>%
  pull(edge_paths) %>%
  unlist()

plot_path = function(node_path) {
  net %>%
    activate("nodes") %>%
    slice(node_path) %>%
    plot(cex = 1.5, lwd = 1.5, add = TRUE)
}

colors = sf.colors(3, categorical = TRUE)

plot(net, col = "grey")
paths %>%
  pull(node_paths) %>%
  walk(plot_path)
net %>%
  activate("nodes") %>%
  st_as_sf() %>%
  slice(c(3, 15)) %>%
  plot(col = colors, pch = 8, cex = 2, lwd = 2, add = TRUE)

```

```{r}
net_sf <- st_as_sf(net)

tm_shape(net_df) +
  tm_dots()

paths %>%
  map(plot_path)

```

Snap dams to trial rivers
```{r}
nepal_rivers_3up <- st_set_geometry(nepal_rivers, "geometry")
nepal_rivers_3up <- st_transform(nepal_rivers_3up, crs = 3857)
nepal_current_dams <- st_transform(nepal_current_dams, crs = 3857)
currentdams_nodes <- st_snap(nepal_current_dams, nepal_rivers_3up, tolerance = 10000)

dim(nepal_current_dams)
dim(currentdams_nodes)

tm_shape(nepal_rivers) +
  tm_lines() +
tm_shape(nepal_current_dams) +
  tm_dots(fill = "red") +
tm_shape(currentdams_nodes) +
  tm_dots(fill = "blue", alpha = 0.5)
  

```

```{r}
nepal_rivers_net <- as_sfnetwork(nepal_rivers_3up)
plot(nepal_rivers_net)
currentdams_nodes <- st_snap(nepal_current_dams, nepal_rivers_net, tolerance = 10000)

colnames(nepal_rivers_net)

nepal_dam_string <- st_split(nepal_rivers_net$geometry, currentdams_nodes$geometry) %>% 
  st_collection_extract("LINESTRING")
```

```{r}
currentdams_nodes <- as_sfnetwork(nepal_current_dams, directed = FALSE)

nepal_river_dams <- st_network_join(nepal_rivers_net, currentdams_nodes)

plot(nepal_river_dams)
```

--------------------------
Read in population data
```{r}
pop <- rast('../../../../capstone/netzerohydro/data/raw/global_pop_2020_CN_1km_R2025A_UA_v1.tif')

plot(pop)
```

